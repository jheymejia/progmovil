<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>EcoChallenge - Descubrir retos</title>
  <!-- Cargar simuladorLocal antes de verificar sesiÃ³n -->
  <script src="../back/simuladorLocal.js"></script>
  <script src="./_sessionCheck.js"></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&amp;display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <style>
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24
    }
  </style>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#4CAF50",
            "background-light": "#F5F5F5",
            "background-dark": "#102212",
            "accent": "#2196F3",
            "tag-accent": "#E57373",
            "text-light": "#111812",
            "text-dark": "#E0E0E0",
            "text-muted-light": "#757575",
            "text-muted-dark": "#BDBDBD",
            "card-light": "#FFFFFF",
            "card-dark": "#1A2C1B",
            "chip-light": "#E0E0E0",
            "chip-dark": "#2C3A2D",
          },
          fontFamily: {
            "display": ["Plus Jakarta Sans", "sans-serif"]
          },
          borderRadius: { "DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "full": "9999px" },
        },
      },
    }
  </script>
  <style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden;
    }

    #app {
      height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      min-height: 100dvh;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .app-content {
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      flex: 1 1 auto;
    }
  </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark">
  <div id="app" class="relative flex min-h-screen w-full flex-col">
    <div class="app-content">
      <header class="sticky top-0 z-10 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm">
        <div class="flex items-center p-4 pb-2 justify-between">
          <h1
            class="flex-1 text-center text-lg font-bold leading-tight tracking-[-0.015em] text-text-light dark:text-text-dark">
            Descubrir retos</h1>
          <button id="btnCerrarSesionTop"
            class="flex h-10 w-10 shrink-0 items-center justify-center text-text-light dark:text-text-dark hover:bg-black/5 dark:hover:bg-white/5 rounded-lg transition-colors"
            title="Cerrar sesiÃ³n">
            <span class="material-symbols-outlined">logout</span>
          </button>
        </div>
      </header>
      <main class="flex-1 pb-24">
        <div class="px-4 py-3">
          <label class="flex flex-col min-w-40 h-12 w-full">
            <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
              <div
                class="text-text-muted-light dark:text-text-muted-dark flex border-none bg-card-light dark:bg-card-dark items-center justify-center pl-4 rounded-l-lg border-r-0">
                <span class="material-symbols-outlined">search</span>
              </div>
              <input
                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light dark:text-text-dark focus:outline-0 focus:ring-2 focus:ring-primary/50 border-none bg-card-light dark:bg-card-dark h-full placeholder:text-text-muted-light dark:placeholder:text-text-muted-dark px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal"
                placeholder="Buscar un reto" value="" />
            </div>
          </label>
        </div>
        <div class="flex gap-3 px-4 py-3 overflow-x-auto">
          <div
            class="categoria-filter flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-full bg-accent text-white px-5 cursor-pointer"
            data-categoria="todos">
            <p class="text-sm font-medium leading-normal">Todos</p>
          </div>
          <div
            class="categoria-filter flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-full bg-chip-light dark:bg-chip-dark px-5 cursor-pointer"
            data-categoria="movilidad">
            <p class="text-text-light dark:text-text-dark text-sm font-medium leading-normal">Movilidad</p>
          </div>
          <div
            class="categoria-filter flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-full bg-chip-light dark:bg-chip-dark px-5 cursor-pointer"
            data-categoria="energia">
            <p class="text-text-light dark:text-text-dark text-sm font-medium leading-normal">EnergÃ­a</p>
          </div>
          <div
            class="categoria-filter flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-full bg-chip-light dark:bg-chip-dark px-5 cursor-pointer"
            data-categoria="residuos">
            <p class="text-text-light dark:text-text-dark text-sm font-medium leading-normal">Residuos</p>
          </div>
          <div
            class="categoria-filter flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-full bg-chip-light dark:bg-chip-dark px-5 cursor-pointer"
            data-categoria="consumo">
            <p class="text-text-light dark:text-text-dark text-sm font-medium leading-normal">Consumo</p>
          </div>
        </div>
        <h2
          class="text-text-light dark:text-text-dark text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">
          Retos destacados</h2>
        <div class="px-4 pb-4">
          <div id="retoDestacado"
            class="flex flex-col gap-4 rounded-xl bg-card-light dark:bg-card-dark p-4 shadow-[0_4px_12px_rgba(0,0,0,0.05)] dark:shadow-[0_4px_12px_rgba(0,0,0,0.2)]">
            <!-- Se cargarÃ¡ dinÃ¡micamente -->
          </div>
        </div>
        <h2
          class="text-text-light dark:text-text-dark text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">
          Retos disponibles</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 px-4 pb-4" id="retosGrid">
          <!-- Los retos se cargarÃ¡n dinÃ¡micamente aquÃ­ -->
        </div>
      </main>
    </div>
    <div class="fixed bottom-24 right-6 z-20">
      <button
        id="btnRetoAleatorio"
        class="flex h-16 w-16 items-center justify-center rounded-full bg-primary text-white shadow-lg hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-background-dark"
        aria-label="Reto aleatorio">
        <span class="material-symbols-outlined text-3xl">casino</span>
      </button>
    </div>
    <!-- Bottom Navigation Bar -->
    <nav
      class="fixed bottom-0 left-0 right-0 flex justify-around border-t border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark px-2 pt-2 pb-4 shadow-[0_-1px_3px_rgba(0,0,0,0.05)]">
      <a class="flex flex-col items-center gap-1 text-gray-500 dark:text-gray-400 w-20 hover:text-primary transition-colors"
        href="dashboard.html">
        <span class="material-symbols-outlined">dashboard</span>
        <span class="text-xs font-medium">Inicio</span>
      </a>
      <a class="flex flex-col items-center gap-1 text-primary w-20" href="availablechallenges.html">
        <span class="material-symbols-outlined">emoji_events</span>
        <span class="text-xs font-bold">Retos</span>
      </a>
      <a class="flex flex-col items-center gap-1 text-gray-500 dark:text-gray-400 w-20 hover:text-primary transition-colors"
        href="community.html">
        <span class="material-symbols-outlined">groups</span>
        <span class="text-xs font-medium">Comunidad</span>
      </a>
      <a class="flex flex-col items-center gap-1 text-gray-500 dark:text-gray-400 w-20 hover:text-primary transition-colors"
        href="profile.html">
        <span class="material-symbols-outlined">person</span>
        <span class="text-xs font-medium">Perfil</span>
      </a>
    </nav>
  </div>

  <script>
    // Cargar retos dinÃ¡micamente desde simuladorLocal
    function cargarRetos(filtroCategoria = null) {
      if (typeof simuladorLocal === 'undefined') {
        setTimeout(() => cargarRetos(filtroCategoria), 100);
        return;
      }

      let retos = simuladorLocal.obtenerTodosRetos();

      // Filtrar por categorÃ­a si es necesario
      if (filtroCategoria && filtroCategoria !== 'todos') {
        retos = retos.filter(r => r.categoria === filtroCategoria);
      }

      // Obtener sesiÃ³n para saber quÃ© retos ya fueron aceptados
      const sesion = simuladorLocal.obtenerSesion();
      const usuario = sesion ? simuladorLocal.obtenerUsuario(sesion.usuarioId) : null;
      const retosAceptados = usuario ? (usuario.retosAceptados || []).map(r => r.retoId) : [];

      // Cargar reto destacado (primer reto disponible)
      cargarRetoDestacado(retos, retosAceptados);

      // Renderizar retos en el grid
      const gridContainer = document.getElementById('retosGrid');
      if (!gridContainer) return;

      gridContainer.innerHTML = '';

      retos.forEach(reto => {
        const estaAceptado = retosAceptados.includes(reto.id);
        const btnTexto = estaAceptado ? 'Ir al reto' : 'Unirse';
        const btnClase = estaAceptado ? 'bg-chip-light dark:bg-chip-dark text-text-light dark:text-text-dark' : 'bg-accent text-white';

        const retoHTML = `
        <div class="flex items-start justify-between gap-4 rounded-xl bg-card-light dark:bg-card-dark p-4 shadow-[0_4px_12px_rgba(0,0,0,0.05)] dark:shadow-[0_4px_12px_rgba(0,0,0,0.2)] cursor-pointer hover:shadow-lg transition-shadow" onclick="irAlReto('${reto.id}')">
          <div class="flex flex-[2_2_0px] flex-col gap-4">
            <div class="flex flex-col gap-1">
              <p class="text-primary dark:text-primary text-sm font-normal leading-normal">${reto.dificultad}, ${reto.categoria}</p>
              <p class="text-text-light dark:text-text-dark text-base font-bold leading-tight">${reto.titulo}</p>
              <p class="text-text-muted-light dark:text-text-muted-dark text-sm font-normal leading-normal">${reto.descripcion}</p>
              <p class="text-accent text-sm font-bold pt-2">+${reto.puntos} puntos</p>
            </div>
            <button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-8 px-4 flex-row-reverse ${btnClase} pr-2 gap-1 text-sm font-medium leading-normal w-fit" onclick="event.stopPropagation(); ${estaAceptado ? `irAlReto('${reto.id}')` : `aceptarReto('${reto.id}')`}">
              <span class="material-symbols-outlined text-base">${estaAceptado ? 'arrow_forward' : 'add'}</span>
              <span class="truncate">${btnTexto}</span>
            </button>
          </div>
          <div class="flex-1 flex items-center justify-center p-2 bg-accent/10 dark:bg-accent/20 rounded-lg text-2xl">
            ${reto.icono || 'ðŸŒ±'}
          </div>
        </div>
      `;
        gridContainer.innerHTML += retoHTML;
      });
    }

    // Cargar reto destacado
    function cargarRetoDestacado(retos, retosAceptados) {
      const container = document.getElementById('retoDestacado');
      if (!container || !retos.length) return;

      // Obtener un reto aleatorio que NO haya sido aceptado
      const retosDisponibles = retos.filter(r => !retosAceptados.includes(r.id));
      const retoDestacado = retosDisponibles.length > 0 
        ? retosDisponibles[Math.floor(Math.random() * retosDisponibles.length)]
        : retos[0];

      const imagenes = [
        'https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?w=800',
        'https://images.unsplash.com/photo-1497436072909-60f360e1d4b1?w=800',
        'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=800',
        'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=800'
      ];
      const imagenAleatoria = imagenes[Math.floor(Math.random() * imagenes.length)];

      container.innerHTML = `
        <div class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-lg"
          style="background-image: url('${imagenAleatoria}');">
        </div>
        <div class="flex flex-col gap-4">
          <div class="flex flex-col gap-1">
            <div class="flex items-center gap-2">
              <span class="inline-block px-3 py-1 text-xs font-medium text-white bg-tag-accent rounded-full">${retoDestacado.dificultad}</span>
              <span class="inline-block px-3 py-1 text-xs font-medium text-white bg-primary rounded-full">${retoDestacado.categoria}</span>
            </div>
            <p class="text-text-light dark:text-text-dark text-base font-bold leading-tight pt-1">${retoDestacado.titulo}</p>
            <p class="text-text-muted-light dark:text-text-muted-dark text-sm font-normal leading-normal">${retoDestacado.descripcion}</p>
            <p class="text-accent text-sm font-bold pt-1">+${retoDestacado.puntos} EcoPuntos</p>
          </div>
          <button
            onclick="aceptarReto('${retoDestacado.id}')"
            class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-accent text-white gap-2 text-sm font-medium leading-normal w-fit self-start">
            <span class="material-symbols-outlined text-base">add</span>
            <span class="truncate">Unirse al reto</span>
          </button>
        </div>
      `;
    }

    // Seleccionar reto aleatorio
    function seleccionarRetoAleatorio() {
      if (typeof simuladorLocal === 'undefined') return;

      const retos = simuladorLocal.obtenerTodosRetos();
      const sesion = simuladorLocal.obtenerSesion();
      const usuario = sesion ? simuladorLocal.obtenerUsuario(sesion.usuarioId) : null;
      const retosAceptados = usuario ? (usuario.retosAceptados || []).map(r => r.retoId) : [];

      // Filtrar retos que aÃºn no han sido aceptados
      const retosDisponibles = retos.filter(r => !retosAceptados.includes(r.id));

      if (retosDisponibles.length === 0) {
        alert('Â¡Ya has aceptado todos los retos disponibles!');
        return;
      }

      // Seleccionar uno aleatorio
      const retoAleatorio = retosDisponibles[Math.floor(Math.random() * retosDisponibles.length)];
      
      // Redirigir al detalle
      irAlReto(retoAleatorio.id);
    }

    // Aceptar reto
    function aceptarReto(retoId) {
      if (typeof simuladorLocal === 'undefined') return;

      const sesion = simuladorLocal.obtenerSesion();
      if (!sesion) {
        window.location.href = './login.html';
        return;
      }

      const resultado = simuladorLocal.aceptarReto(sesion.usuarioId, retoId);
      if (resultado.error) {
        alert('Error: ' + resultado.error);
      } else {
        alert('Â¡Reto aceptado! Ahora puedes completarlo.');
        cargarRetos();
      }
    }

    // Ir al detalle del reto
    function irAlReto(retoId) {
      window.location.href = './challengedetails.html?id=' + retoId;
    }

    // Filtrar por categorÃ­a
    function filtrarPorCategoria(categoria) {
      cargarRetos(categoria);
    }

    // Cerrar sesiÃ³n
    function cerrarSesion() {
      if (typeof simuladorLocal !== 'undefined') {
        simuladorLocal.limpiarSesion();
      }
      window.location.href = './login.html';
    }

    document.addEventListener('DOMContentLoaded', function () {
      const btnCerrar = document.getElementById('btnCerrarSesionTop');
      if (btnCerrar) {
        btnCerrar.addEventListener('click', cerrarSesion);
      }

      // FAB - Reto aleatorio
      const btnAleatorio = document.getElementById('btnRetoAleatorio');
      if (btnAleatorio) {
        btnAleatorio.addEventListener('click', seleccionarRetoAleatorio);
      }

      // Cargar retos inicialmente
      cargarRetos();

      // Agregar listeners a los filtros de categorÃ­a
      const botonesCategoria = document.querySelectorAll('.categoria-filter');
      botonesCategoria.forEach(btn => {
        btn.addEventListener('click', function () {
          const categoria = this.dataset.categoria;
          // Cambiar estilo del botÃ³n activo
          botonesCategoria.forEach(b => b.classList.remove('bg-accent', 'text-white'));
          botonesCategoria.forEach(b => b.classList.add('bg-chip-light', 'dark:bg-chip-dark'));
          this.classList.remove('bg-chip-light', 'dark:bg-chip-dark');
          this.classList.add('bg-accent', 'text-white');
          // Filtrar
          filtrarPorCategoria(categoria);
        });
      });
    });
  </script>

</body>

</html>