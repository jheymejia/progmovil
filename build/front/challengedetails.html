<!DOCTYPE html>
<html lang="es"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>EcoChallenge - Detalle de reto</title>
<!-- Cargar simuladorLocal antes de verificar sesi√≥n -->
<script src="../back/simuladorLocal.js"></script>
<script src="_sessionCheck.js"></script>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#4A7C59",
            "secondary": "#87CEEB",
            "accent": "#FFC107",
            "background-light": "#F8F9FA",
            "background-dark": "#1a1a1a",
            "text-light": "#343A40",
            "text-dark": "#F8F9FA",
            "border-light": "#E9ECEF",
            "border-dark": "#4a4a4a",
          },
          fontFamily: {
            "display": ["Plus Jakarta Sans", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "0.75rem",
            "lg": "1rem",
            "xl": "1.5rem",
            "full": "9999px"
          },
        },
      },
    }
  </script>
<style>
    .material-symbols-outlined {
      font-variation-settings:
      'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 24
    }
  </style>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  </head>
<body class="font-display">
<style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden;
    }
    #app {
      height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      min-height: 100dvh;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .app-content {
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      flex: 1 1 auto;
    }
  </style>
</head>
<body class="font-display">
<div id="app" class="relative flex min-h-screen w-full flex-col bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden text-text-light dark:text-text-dark">
  <div class="app-content">
  <div class="flex items-center bg-background-light dark:bg-background-dark p-4 pb-2 justify-between sticky top-0 z-10">
<button onclick="window.history.back()" class="flex size-12 shrink-0 items-center justify-center cursor-pointer hover:bg-black/5 dark:hover:bg-white/5 rounded-lg transition-colors">
<span class="material-symbols-outlined text-text-light dark:text-text-dark">arrow_back</span>
</button>
<div class="flex w-12 items-center justify-end">
<button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 bg-transparent text-text-light dark:text-text-dark gap-2 text-base font-bold leading-normal tracking-[0.015em] min-w-0 p-0" onclick="compartirReto()">
<span class="material-symbols-outlined">share</span>
</button>
</div>
</div>
<main class="flex-grow">
<div class="px-4 pt-2">
<div id="imagenReto" class="w-full h-60 sm:h-80 object-cover rounded-xl bg-gray-300 dark:bg-gray-700"></div>
</div>
<h1 id="tituloReto" class="text-text-light dark:text-text-dark tracking-tight text-[32px] font-bold leading-tight px-4 text-left pb-1 pt-4">Cargando reto...</h1>
<div id="tagsReto" class="flex gap-3 px-4 pt-3 flex-wrap">
<!-- Tags se cargar√°n din√°micamente -->
</div>
<div class="flex flex-col gap-4 p-4">
<div class="flex flex-col gap-4 rounded-xl border border-border-light dark:border-border-dark bg-white dark:bg-background-dark p-4">
<h3 class="text-text-light dark:text-text-dark text-lg font-bold leading-tight tracking-[-0.015em]">Por qu√© importa</h3>
<p id="porQueImporta" class="text-text-light/80 dark:text-text-dark/80 text-base leading-relaxed">Cargando descripci√≥n...</p>
</div>
<div class="flex flex-col gap-4 rounded-xl border border-border-light dark:border-border-dark bg-white dark:bg-background-dark p-4">
<h3 class="text-text-light dark:text-text-dark text-lg font-bold leading-tight tracking-[-0.015em]">C√≥mo completarlo</h3>
<ul id="pasos" class="space-y-3">
<!-- Los pasos se cargar√°n din√°micamente -->
</ul>
</div>
</div>
</main>
  </div>
  <div class="sticky bottom-0 bg-background-light dark:bg-background-dark p-4 w-full border-t border-border-light dark:border-border-dark">
    <button id="btnAccion" class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 bg-primary text-white gap-2 text-base font-bold leading-normal tracking-wide transition-colors hover:bg-primary/90" onclick="procesarAccion()">Aceptar este reto</button>
  </div>
</div>

<script>
  let retoActual = null;
  let usuarioActual = null;

  function obtenerIdRetoDelURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get('id');
  }

  function cargarDetalleReto() {
    if (typeof simuladorLocal === 'undefined') {
      setTimeout(cargarDetalleReto, 100);
      return;
    }

    const retoId = obtenerIdRetoDelURL();
    if (!retoId) {
      mostrarError('Reto no encontrado en la URL');
      return;
    }

    // Obtener reto
    retoActual = simuladorLocal.obtenerRetoPorId(retoId);
    if (!retoActual) {
      mostrarError('Reto no disponible en la base de datos');
      return;
    }

    // Obtener usuario actual
    const sesion = simuladorLocal.obtenerSesion();
    if (sesion) {
      usuarioActual = simuladorLocal.obtenerUsuario(sesion.usuarioId);
    }

    if (!usuarioActual) {
      mostrarError('Usuario no encontrado. Inicia sesi√≥n nuevamente.');
      return;
    }

    // Renderizar datos
    document.title = 'EcoChallenge - ' + retoActual.titulo;
    document.getElementById('tituloReto').textContent = retoActual.titulo;
    document.getElementById('porQueImporta').textContent = retoActual.descripcion;

    // Cargar imagen de fondo (simulada con emoji + color)
    const colores = { movilidad: '#87CEEB', consumo: '#FFB6C1', energia: '#FFD700', residuos: '#90EE90' };
    const imgDiv = document.getElementById('imagenReto');
    imgDiv.style.backgroundColor = colores[retoActual.categoria] || '#CCC';
    imgDiv.textContent = retoActual.icono || 'üå±';
    imgDiv.style.fontSize = '60px';
    imgDiv.style.display = 'flex';
    imgDiv.style.alignItems = 'center';
    imgDiv.style.justifyContent = 'center';

    // Renderizar tags
    const tagsDiv = document.getElementById('tagsReto');
    tagsDiv.innerHTML = `
      <div class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-primary/20 text-primary px-4">
        <p class="text-sm font-medium leading-normal">${retoActual.categoria}</p>
      </div>
      <div class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-secondary/20 text-secondary px-4">
        <p class="text-sm font-medium leading-normal">Dificultad ${retoActual.dificultad}</p>
      </div>
      <div class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-accent/20 px-4">
        <p class="text-accent text-sm font-bold leading-normal">+${retoActual.puntos} puntos</p>
      </div>
    `;

    // Renderizar pasos
    const pasosDiv = document.getElementById('pasos');
    pasosDiv.innerHTML = `
      <li class="flex items-start gap-3">
        <span class="material-symbols-outlined text-primary mt-0.5">check_circle</span>
        <span class="text-text-light/80 dark:text-text-dark/80 text-base leading-relaxed">${retoActual.descripcion}</span>
      </li>
      <li class="flex items-start gap-3">
        <span class="material-symbols-outlined text-primary mt-0.5">check_circle</span>
        <span class="text-text-light/80 dark:text-text-dark/80 text-base leading-relaxed">Registra tu progreso en la app.</span>
      </li>
      <li class="flex items-start gap-3">
        <span class="material-symbols-outlined text-primary mt-0.5">check_circle</span>
        <span class="text-text-light/80 dark:text-text-dark/80 text-base leading-relaxed">Gana <strong>${retoActual.puntos} puntos</strong> al completar.</span>
      </li>
    `;

    // Actualizar bot√≥n seg√∫n estado
    actualizarBoton();
  }

  function actualizarBoton() {
    const btn = document.getElementById('btnAccion');
    if (!usuarioActual || !retoActual) return;

    const estaAceptado = (usuarioActual.retosAceptados || []).find(r => r.retoId === retoActual.id);
    const estaCompletado = (usuarioActual.retosCompletados || []).find(r => r.retoId === retoActual.id);

    if (estaCompletado) {
      btn.textContent = '‚úì Reto completado';
      btn.disabled = true;
      btn.classList.remove('bg-primary', 'hover:bg-primary/90');
      btn.classList.add('bg-gray-400', 'cursor-not-allowed');
    } else if (estaAceptado) {
      btn.textContent = 'Completar reto';
      btn.classList.add('bg-primary', 'hover:bg-primary/90');
      btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
      btn.disabled = false;
    } else {
      btn.textContent = 'Aceptar este reto';
      btn.classList.add('bg-primary', 'hover:bg-primary/90');
      btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
      btn.disabled = false;
    }
  }

  function procesarAccion() {
    if (!usuarioActual || !retoActual) {
      mostrarError('Datos no disponibles. Recarga la p√°gina.');
      return;
    }

    const estaAceptado = (usuarioActual.retosAceptados || []).find(r => r.retoId === retoActual.id);
    const estaCompletado = (usuarioActual.retosCompletados || []).find(r => r.retoId === retoActual.id);

    if (estaCompletado) {
      alert('Ya completaste este reto.');
      return;
    }

    if (estaAceptado) {
      // Completar reto
      completarReto();
    } else {
      // Aceptar reto
      aceptarReto();
    }
  }

  function aceptarReto() {
    if (!usuarioActual || !retoActual) return;

    const resultado = simuladorLocal.aceptarReto(usuarioActual.id, retoActual.id);
    
    if (resultado.error) {
      mostrarError('No se pudo aceptar: ' + resultado.error);
    } else {
      usuarioActual = resultado;
      // Actualizar sesi√≥n
      simuladorLocal.guardarSesion(resultado);
      alert('¬°Reto aceptado! üéØ Ahora puedes completarlo cuando lo hayas realizado.');
      actualizarBoton();
    }
  }

  function completarReto() {
    if (!usuarioActual || !retoActual) return;

    // Confirmar que el usuario complet√≥ el reto
    const confirmacion = confirm('¬øConfirmas que completaste este reto?\n\nGanar√°s ' + retoActual.puntos + ' puntos.');
    
    if (!confirmacion) return;

    const resultado = simuladorLocal.completarReto(usuarioActual.id, retoActual.id);
    
    if (resultado.error) {
      mostrarError('No se pudo completar: ' + resultado.error);
    } else {
      usuarioActual = resultado;
      // Actualizar sesi√≥n
      simuladorLocal.guardarSesion(resultado);
      
      alert('¬°Felicidades! üéâ\n\nCompletaste "' + retoActual.titulo + '"\nGanaste ' + retoActual.puntos + ' puntos\nTus puntos totales: ' + resultado.puntosTotales);
      actualizarBoton();
    }
  }

  function compartirReto() {
    if (!retoActual) return;
    
    const mensaje = 'Estoy completando el reto: "' + retoActual.titulo + '" en EcoChallenge üå± ¬°√önete a m√≠!';
    
    if (navigator.share) {
      navigator.share({
        title: 'EcoChallenge',
        text: mensaje
      }).catch(err => console.log('Error compartiendo:', err));
    } else {
      alert(mensaje + '\n\n(Copia este mensaje para compartir)');
    }
  }

  function mostrarError(mensaje) {
    alert('‚ùå Error: ' + mensaje);
    setTimeout(() => window.history.back(), 1500);
  }

  // Cargar al iniciar
  document.addEventListener('DOMContentLoaded', cargarDetalleReto);
  cargarDetalleReto(); // Tambi√©n intentar cargar inmediatamente
</script>