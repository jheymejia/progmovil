<!DOCTYPE html>

<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>EcoChallenge - Iniciar sesión / Registrarse</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&amp;display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#4CAF50",
            "secondary": "#26A69A",
            "background-light": "#F5F5F5",
            "background-dark": "#102212",
            "text-light": "#424242",
            "text-dark": "#E0E0E0",
            "muted-light": "#757575",
            "muted-dark": "#9E9E9E",
            "border-light": "#E0E0E0",
            "border-dark": "#424242",
            "accent": "#FF7043",
          },
          fontFamily: {
            "display": ["Plus Jakarta Sans", "sans-serif"]
          },
          borderRadius: { "DEFAULT": "0.75rem", "lg": "1rem", "xl": "1.5rem", "full": "9999px" },
        },
      },
    }
  </script>
  <style>
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
  </style>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden; /* prevent page scrolling; internal containers may scroll */
    }
    /* App shell fills the safe viewport on mobile devices and respects notches/home bars */
    #app {
      height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      min-height: 100dvh;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      align-items: center;
      justify-content: center;
    }
    /* Allow internal scrolling for overflow inside the app shell */
    .app-content {
      width: 100%;
      max-width: 100%;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark">
  <!-- Cargar simuladorLocal para acceso a CRUD -->
  <script src="../back/simuladorLocal.js"></script>
  <div id="app"
    class="relative flex min-h-screen w-full flex-col items-center justify-center bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden p-4">
    <!-- Background element -->
    <div class="absolute top-0 left-0 w-full h-full opacity-10 dark:opacity-5 bg-cover bg-center"
      data-alt="Subtle background image of a forest floor with light filtering through the trees."
      style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuBlLZqOF4h3OFxj9akcCcpB87Gh0XrELTeasLsfpp0KgRJ9YJ-DJ4fbz_K7zJsxZl5Dx1BcHnbYo058EYAC3ea0-52o638BEe_As2FFJVanRfRKS-a3jv5bTSFWVLJLAZVpP6Nu-PSp-aomlgEeSWwRphkHZKjxi-Zd4c-VKO0y8qtrpfxkUs6ThR3BK4-wF3sTSUgyvKibTEp5rylBtOiplfyt3EFmJvlnqQdVCClgaAuyWobJ3_bsZ6zDGID_Yty1jnvwfCcfDSYT');">
    </div>
    <div class="relative z-10 w-full max-w-md app-content">
      <!-- Header Section -->
      <div class="text-center">
        <h1 class="text-primary tracking-tight text-[32px] font-bold leading-tight">EcoChallenge</h1>
        <p class="text-muted-light dark:text-muted-dark text-base font-normal leading-normal pt-1 pb-6">Únete al
          movimiento por un planeta más verde.</p>
      </div>
      <!-- Segmented Buttons / Toggle -->
      <div class="flex px-4 py-3">
        <div class="flex h-12 flex-1 items-center justify-center rounded-xl bg-gray-200 dark:bg-black/20 p-1">
          <label
            class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-lg px-2 has-[:checked]:bg-white has-[:checked]:dark:bg-background-dark has-[:checked]:shadow-sm has-[:checked]:text-text-light has-[:checked]:dark:text-text-dark text-muted-light dark:text-muted-dark text-sm font-medium leading-normal transition-all duration-200">
            <span class="truncate">Iniciar sesión</span>
            <input checked="" class="invisible w-0" id="modoLogin" name="auth-toggle" type="radio" value="login" onchange="cambiarModo('login')" />
          </label>
          <label
            class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-lg px-2 has-[:checked]:bg-white has-[:checked]:dark:bg-background-dark has-[:checked]:shadow-sm has-[:checked]:text-text-light has-[:checked]:dark:text-text-dark text-muted-light dark:text-muted-dark text-sm font-medium leading-normal transition-all duration-200">
            <span class="truncate">Registrarse</span>
            <input class="invisible w-0" id="modoRegistro" name="auth-toggle" type="radio" value="registro" onchange="cambiarModo('registro')" />
          </label>
        </div>
      </div>
      <!-- Forms Section -->
      <form id="formAuth" class="space-y-4 pt-4" onsubmit="return procesarAuth(event)">
        <!-- Campo Nombre (solo en registro) -->
        <div id="fieldNombre" class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 hidden">
          <label class="flex flex-col min-w-40 flex-1">
            <p class="text-text-light dark:text-text-dark text-base font-medium leading-normal pb-2">Nombre completo</p>
            <input
              id="inputNombre"
              class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light dark:text-text-dark focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-light dark:border-border-dark bg-white/50 dark:bg-black/20 h-14 placeholder:text-muted-light dark:placeholder:text-muted-dark p-[15px] text-base font-normal leading-normal transition-colors"
              placeholder="Introduce tu nombre completo" type="text" value="" />
          </label>
        </div>
        <!-- Campo Correo electrónico -->
        <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4">
          <label class="flex flex-col min-w-40 flex-1">
            <p class="text-text-light dark:text-text-dark text-base font-medium leading-normal pb-2">Correo electrónico</p>
            <input
              id="inputEmail"
              class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light dark:text-text-dark focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-light dark:border-border-dark bg-white/50 dark:bg-black/20 h-14 placeholder:text-muted-light dark:placeholder:text-muted-dark p-[15px] text-base font-normal leading-normal transition-colors"
              placeholder="Introduce tu correo electrónico" type="email" value="" required />
          </label>
        </div>
        <!-- Campo Contraseña -->
        <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4">
          <label class="flex flex-col min-w-40 flex-1">
            <div class="flex justify-between items-center pb-2">
              <p class="text-text-light dark:text-text-dark text-base font-medium leading-normal">Contraseña</p>
              <a id="linkOlvidePassword" class="text-secondary text-sm font-medium hover:underline" href="#">¿Olvidaste tu contraseña?</a>
            </div>
            <div class="relative w-full">
              <input
                id="inputPassword"
                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light dark:text-text-dark focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-light dark:border-border-dark bg-white/50 dark:bg-black/20 h-14 placeholder:text-muted-light dark:placeholder:text-muted-dark p-[15px] pr-12 text-base font-normal leading-normal transition-colors"
                placeholder="Introduce tu contraseña" type="password" value="" required />
              <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-4 text-muted-light dark:text-muted-dark" onclick="togglePasswordVisibility()">
                <span class="material-symbols-outlined" id="iconPassword">visibility_off</span>
              </button>
            </div>
          </label>
        </div>
        <!-- Mensaje de error/éxito -->
        <div id="mensajeAuth" class="px-4 hidden rounded-lg p-3 text-sm font-semibold transition-all duration-200 opacity-0"></div>
      </form>
      <!-- Primary CTA Button -->
      <div class="px-4 pt-6">
        <button
          id="btnAuth"
          type="submit"
          form="formAuth"
          data-mode="login"
          class="flex h-14 w-full items-center justify-center rounded-lg bg-primary text-white text-base font-bold leading-normal shadow-md hover:bg-primary/90 transition-colors">Iniciar sesión</button>
      </div>
      <!-- Social Login Divider (solo en login) -->
      <div id="dividerSocial" class="flex items-center gap-4 px-4 py-6">
        <div class="h-px flex-1 bg-border-light dark:bg-border-dark"></div>
        <p class="text-sm font-medium text-muted-light dark:text-muted-dark">O continuar con</p>
        <div class="h-px flex-1 bg-border-light dark:bg-border-dark"></div>
      </div>
      <!-- Social Login Buttons (solo en login) -->
      <div id="socialButtons" class="px-4">
        <button type="button"
          class="flex h-14 w-full items-center justify-center gap-3 rounded-lg border border-border-light dark:border-border-dark bg-white/50 dark:bg-black/20 text-text-light dark:text-text-dark text-base font-medium leading-normal hover:bg-gray-100 dark:hover:bg-black/30 transition-colors">
          <svg class="h-6 w-6" fill="none" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M22.578 12.27c0-.79-.07-1.54-.2-2.27h-9.77v4.28h5.68c-.24 1.38-.97 2.56-2.05 3.36v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.14z"
              fill="#4285F4"></path>
            <path
              d="M12.608 23c3.24 0 5.95-1.08 7.93-2.91l-3.57-2.77c-1.08.72-2.45 1.16-4.36 1.16-3.36 0-6.2-2.26-7.22-5.3h-3.68v2.86c2.18 4.31 6.56 7.22 11.55 7.22z"
              fill="#34A853"></path>
            <path
              d="M5.388 13.78c-.2-.6-.32-1.24-.32-1.91s.12-1.31.32-1.91V7.1H1.708c-.64 1.28-1.01 2.74-1.01 4.31s.37 3.03 1.01 4.31l3.68-2.86z"
              fill="#FBBC05"></path>
            <path
              d="M12.608 4.52c1.76 0 3.34.6 4.6 1.83l3.16-3.16C18.558 1.12 15.848 0 12.608 0 7.618 0 3.238 2.91 1.058 7.22l3.68 2.86c1.02-3.04 3.86-5.3 7.87-5.3z"
              fill="#EA4335"></path>
          </svg>
          Continuar con Google
        </button>
      </div>
      <p class="text-xs text-muted-light dark:text-muted-dark text-center px-4 pt-6">Al continuar, aceptas nuestros <a
          class="text-secondary hover:underline" href="#">Términos de servicio</a> y la <a
          class="text-secondary hover:underline" href="#">Política de privacidad</a>.</p>
    </div>
  </div>

  <script>
    // Variables globales para controlar el modo actual
    let modoActual = 'login';
    const textoBotonPorModo = {
      login: 'Iniciar sesión',
      registro: 'Guardar Registro'
    };
    let mensajeTimeout;

    // Cambiar entre modo login y registro
    function cambiarModo(modo) {
      modoActual = modo;
      const fieldNombre = document.getElementById('fieldNombre');
      const linkOlvidePassword = document.getElementById('linkOlvidePassword');
      const btnAuth = document.getElementById('btnAuth');
      const dividerSocial = document.getElementById('dividerSocial');
      const socialButtons = document.getElementById('socialButtons');
      const formAuth = document.getElementById('formAuth');
      
      if (modo === 'registro') {
        // Mostrar campo nombre, ocultar "olvide contraseña" y botones sociales
        fieldNombre.classList.remove('hidden');
        linkOlvidePassword.classList.add('hidden');
        dividerSocial.classList.add('hidden');
        socialButtons.classList.add('hidden');
        
        // Cambiar texto del botón
        btnAuth.textContent = textoBotonPorModo.registro;
        btnAuth.dataset.mode = 'registro';
        
        // Limpiar el campo nombre en el formulario
        document.getElementById('inputNombre').required = true;
      } else {
        // Mostrar "olvide contraseña" y botones sociales, ocultar campo nombre
        fieldNombre.classList.add('hidden');
        linkOlvidePassword.classList.remove('hidden');
        dividerSocial.classList.remove('hidden');
        socialButtons.classList.remove('hidden');
        
        // Cambiar texto del botón
        btnAuth.textContent = textoBotonPorModo.login;
        btnAuth.dataset.mode = 'login';
        
        // No requerir nombre en modo login
        document.getElementById('inputNombre').required = false;
      }
      
      // Limpiar formulario y mensaje
      formAuth.reset();
      limpiarMensaje();
    }

    // Toggle de visibilidad de contraseña
    function togglePasswordVisibility() {
      const inputPassword = document.getElementById('inputPassword');
      const iconPassword = document.getElementById('iconPassword');
      
      if (inputPassword.type === 'password') {
        inputPassword.type = 'text';
        iconPassword.textContent = 'visibility';
      } else {
        inputPassword.type = 'password';
        iconPassword.textContent = 'visibility_off';
      }
    }

    // Procesar autenticación o registro
    function procesarAuth(event) {
      event.preventDefault();
      
      const email = document.getElementById('inputEmail').value.trim();
      const password = document.getElementById('inputPassword').value;
      
      if (modoActual === 'login') {
        // Iniciar sesión
        autenticarUsuario(email, password);
      } else {
        // Registrar nuevo usuario
        const nombre = document.getElementById('inputNombre').value.trim();
        if (!nombre) {
          mostrarMensaje('Por favor completa el nombre', 'error');
          return false;
        }
        registrarUsuario(nombre, email, password);
      }
      
      return false;
    }

    // Autenticar usuario existente
    function autenticarUsuario(email, password) {
      // Verificar que simuladorLocal esté disponible
      if (typeof simuladorLocal === 'undefined') {
        mostrarMensaje('Error: sistema no iniciado', 'error');
        return;
      }

      setBotonCargando('Validando...');

      try {
        const resultado = simuladorLocal.autenticarUsuario(email, password);

        if (resultado.error) {
          resetEstadoBoton();
          mostrarMensaje(obtenerMensajeErrorLogin(resultado.error), 'error');
          return;
        }

        mostrarMensaje('Bienvenido, ' + resultado.usuario.nombre + '!', 'success');
        setTimeout(() => {
          simuladorLocal.guardarSesion(resultado.usuario);
          resetEstadoBoton();
          window.location.href = './dashboard.html';
        }, 1100);
      } catch (error) {
        resetEstadoBoton();
        mostrarMensaje('Ocurrió un error inesperado. Intenta de nuevo.', 'error');
        console.error('Error en autenticación:', error);
      }
    }

    // Registrar nuevo usuario
    function registrarUsuario(nombre, email, password) {
      // Verificar que simuladorLocal esté disponible
      if (typeof simuladorLocal === 'undefined') {
        mostrarMensaje('Error: sistema no iniciado', 'error');
        return;
      }

      setBotonCargando('Registrando...');

      try {
        const resultado = simuladorLocal.crearUsuario({
          nombre: nombre,
          email: email,
          password: password
        });

        if (resultado.error) {
          resetEstadoBoton();
          mostrarMensaje(obtenerMensajeErrorRegistro(resultado.error), 'error');
          return;
        }

        mostrarMensaje('Registro completado. Iniciando sesión...', 'success');
        setTimeout(() => {
          simuladorLocal.guardarSesion(resultado);
          resetEstadoBoton();
          window.location.href = './dashboard.html';
        }, 1100);
      } catch (error) {
        resetEstadoBoton();
        mostrarMensaje('Ocurrió un error inesperado. Intenta nuevamente.', 'error');
        console.error('Error en registro:', error);
      }
    }

    // Guardar sesión en localStorage
    function guardarSesion(usuario) {
      localStorage.setItem('ecochallenge_sesion', JSON.stringify(usuario));
    }

    // Mostrar mensaje de error o éxito
    function mostrarMensaje(mensaje, tipo) {
      const divMensaje = document.getElementById('mensajeAuth');
      clearTimeout(mensajeTimeout);
      divMensaje.textContent = mensaje;
      divMensaje.className = 'px-4 rounded-lg p-3 text-sm font-semibold transition-all duration-200 shadow-sm border opacity-100';
      if (tipo === 'error') {
        divMensaje.classList.add('border-red-200', 'bg-red-50', 'text-red-700', 'dark:border-red-500/70', 'dark:bg-red-900/30', 'dark:text-red-200');
      } else if (tipo === 'success') {
        divMensaje.classList.add('border-green-200', 'bg-green-50', 'text-green-700', 'dark:border-green-500/70', 'dark:bg-green-900/30', 'dark:text-green-200');
      }
      divMensaje.classList.remove('hidden');
      divMensaje.classList.remove('opacity-0');
      mensajeTimeout = setTimeout(() => ocultarMensaje(), 4200);
    }

    function ocultarMensaje() {
      const divMensaje = document.getElementById('mensajeAuth');
      divMensaje.classList.add('opacity-0');
      setTimeout(() => divMensaje.classList.add('hidden'), 220);
    }

    // Limpiar mensaje
    function limpiarMensaje() {
      clearTimeout(mensajeTimeout);
      const divMensaje = document.getElementById('mensajeAuth');
      divMensaje.className = 'px-4 hidden rounded-lg p-3 text-sm font-semibold transition-all duration-200 opacity-0';
      divMensaje.textContent = '';
    }

    function setBotonCargando(texto) {
      const btnAuth = document.getElementById('btnAuth');
      btnAuth.dataset.originalLabel = btnAuth.textContent;
      btnAuth.disabled = true;
      btnAuth.textContent = texto;
      btnAuth.style.opacity = '0.64';
      btnAuth.setAttribute('aria-busy', 'true');
    }

    function resetEstadoBoton() {
      const btnAuth = document.getElementById('btnAuth');
      const modo = btnAuth.dataset.mode || modoActual;
      const textoBase = btnAuth.dataset.originalLabel || textoBotonPorModo[modo] || textoBotonPorModo.login;
      btnAuth.textContent = textoBase;
      btnAuth.disabled = false;
      btnAuth.style.opacity = '1';
      btnAuth.removeAttribute('aria-busy');
      delete btnAuth.dataset.originalLabel;
    }

    function obtenerMensajeErrorLogin(error) {
      if (error === 'Usuario no encontrado') {
        return 'No se encontró una cuenta con ese correo. Verifica tu email.';
      }
      if (error === 'Contraseña incorrecta') {
        return 'La contraseña no coincide. Intenta nuevamente.';
      }
      return 'Credenciales inválidas. Por favor revisa tus datos.';
    }

    function obtenerMensajeErrorRegistro(error) {
      if (error === 'El email ya está registrado') {
        return 'Ese correo ya tiene una cuenta. ¿Quieres iniciar sesión?';
      }
      return 'No pudimos completar el registro. Revisa los datos y vuelve a intentarlo.';
    }

    
  </script>